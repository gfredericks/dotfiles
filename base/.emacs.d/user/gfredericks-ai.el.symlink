(provide 'gfredericks-ai)

(require 'gfredericks-longrunning)
(require 'gfredericks-packages)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; gptel

;; Thanks Bruce Hauman!

(gfredericks-packages-install 'gptel)

(require 'gptel)

(setq gptel-api-key (getenv "OPENAI_API_KEY"))

(gptel-make-anthropic "Claude"          ;Any name you want
  :stream t                             ;Streaming responses
  :key (getenv "ANTHROPIC_API_KEY"))

;; (gptel-make-gemini "Gemini"
;;   :key (getenv "GEMINI_API_KEY")
;;   :stream t)

(setq gptel-model 'gpt-5)
(defun gfredericks-gptel-mode-external-system-message ()
  (save-excursion
    (goto-char (point-min))
    (let ((system-file (org-entry-get nil "GPTEL_SYSTEM_FILE")))
      (when system-file
        (setq-local gptel--system-message
                    (with-temp-buffer
                      (insert-file-contents system-file)
                      (buffer-string))))))
  )

(add-hook 'gptel-mode-hook 'gfredericks-gptel-mode-external-system-message)

(setq gptel-log-level 'info) ;; nil, 'info, 'debug

(defun gfredericks-gptel-add-agenda-context ()
  (beginning-of-buffer)

  (insert "<context>")
  (insert (format-time-string "Current date/time: %Y-%m-%d %A %H:%M:%S %Z"))
  (insert "\nCURRENT AGENDA:\n")
  (insert (gfredericks-assistant-get-agenda))
  (insert "\n</context>\n"))

(defun gfredericks-gptel-add-agenda-context-hook ()
  (save-excursion
    (goto-char (point-min))
    (let ((mode (org-entry-get nil "GFREDERICKS_AI_MODE")))
      (when (string= mode "productivity-assistant")
        (add-hook 'gptel-prompt-filter-hook 'gfredericks-gptel-add-agenda-context nil t)))))

(add-hook 'gptel-mode-hook 'gfredericks-gptel-add-agenda-context-hook)

(add-hook 'gptel-post-stream-hook 'gptel-auto-scroll)
(add-hook 'gptel-post-response-functions 'gptel-end-of-response)

(defun gfredericks-assistant-get-agenda ()
  (concat (with-current-buffer "agenda.org"
            (goto-char (point-min))
            ;; now go to the next occurrence of "Items"
            (re-search-forward " \\(FREE\\|MUSTDO\\) ")
            (forward-line 2)
            (let ((start (point)))
              (search-forward " LATER ")
              (beginning-of-line)
              (let ((end (point)))
                (buffer-substring-no-properties start end))))
          "\n\n IN PROGRESS ITEMS:\n\n"
          (with-current-buffer "context.org"
            (goto-char (point-min))
            (search-forward ";;;;;")
            (forward-line -1)
            (buffer-substring-no-properties (point-min) (point)))))

(defun assistant ()
  (interactive)
  (let ((today (format-time-string "%Y-%m-%d")))
    (find-file (concat (getenv "HOME")
                       "/dev/drw/drw/ai-assistant/"
                       today
                       ".org"))))

(defun prepend-current-time ()
  (save-excursion
    (let ((re "^\\*\\*\\* "))
      (if (re-search-backward re nil t)
          (progn
            (goto-char (match-beginning 0))
            (forward-char 4)
            (insert (format-time-string "%H:%M -- ")))
        (message "Can't find beginning of prompt")))))

(defun gfredericks-before-gptel-send (&rest args)
  (if (and (derived-mode-p 'org-mode)
           (string= "productivity-assistant"
                    (org-entry-get (point-min) "GFREDERICKS_AI_MODE")))
      (prepend-current-time)))

(advice-add 'gptel-send :before #'gfredericks-before-gptel-send)

(defun gfredericks-ai-assistant-clock-in ()
  (interactive)
  (let ((buffer-end (buffer-substring-no-properties (- (point-max) 5) (point-max))))
    (unless (string-equal buffer-end "*** \n")
      (error "Failed to clock in"))
    (goto-char (- (point-max) 1)))
  (insert "CLOCK IN")
  (gptel-send)
  (save-buffer))

(defun gfredericks-ai-assistant-clock-out ()
  (interactive)
  (let ((buffer-end (buffer-substring-no-properties (- (point-max) 5) (point-max))))
    (unless (string-equal buffer-end "*** \n")
      (error "Failed to clock out"))
    (goto-char (- (point-max) 1)))
  (insert "CLOCK OUT")
  (prepend-current-time)
  (end-of-buffer)
  (insert "\n*** ")
  (save-buffer))

;; NOCOMMIT: I don't think we want this, but rather the two define-keys below
;; (defun gfredericks-ai-assistant-clocking-functions ()
;;   (local-set-key (kbd "C-c C-x C-i") 'gfredericks-ai-assistant-clock-in)
;;   (local-set-key (kbd "C-c C-x C-o") 'gfredericks-ai-assistant-clock-out))
;; (add-hook 'gptel-mode-hook 'gfredericks-ai-assistant-clocking-functions)

(define-key gptel-mode-map (kbd "C-c C-x C-i") 'gfredericks-ai-assistant-clock-in)
(define-key gptel-mode-map (kbd "C-c C-x C-o") 'gfredericks-ai-assistant-clock-out)


(defun is-codex-running? (buffer-name)
  (interactive)
  "Returns true if the buffer given by buffer-name has the texts
   \"Working\" and \"Esc to interrupt\" on its last line."
  (with-current-buffer buffer-name
    (save-excursion
      (goto-char (point-max))
      (let ((last-line (thing-at-point 'line t)))
        (and (string-match "Working" last-line) t)))))

(defun is-bash-running? (buffer-name)
  (interactive)
  "Returns true if the buffer given by buffer-name has the text
   \"$ \" on its last line"
  (with-current-buffer buffer-name
    (save-excursion
      (goto-char (point-max))
      (let ((last-line (thing-at-point 'line t)))
        (not (string-match-p "^\\$[ \t\r\n]*$" last-line))))))
