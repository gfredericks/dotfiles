#!/usr/bin/env bash

set -Eeou pipefail

if [ "$#" -lt 2 ]; then
  echo "Usage: $0 timestamp command..." 1>&2
  exit 1
fi

timestamp="$1"
shift

if ! deadline_epoch=$(date -d "$timestamp" +%s 2>/dev/null); then
  echo "Invalid timestamp: $timestamp" 1>&2
  exit 1
fi

set +e
"$@"
rc=$?
set -e

if (( rc > 0 )); then
    now_epoch=$(date +%s)
    if (( now_epoch > deadline_epoch )); then
        echo "timed out waiting for $@"
        exit 0
    fi
fi

exit "$rc"
