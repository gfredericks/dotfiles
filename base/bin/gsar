#!/usr/bin/env python3

import os
import re
import sys
from pathlib import Path
import subprocess

def hidden(filename):
    # Check if the file is hidden by examining the basename
    return Path(filename).name.startswith('.')

def main():
    if len(sys.argv) != 4:
        print("Usage: gsar <dir> <matcher> <replacement>")
        sys.exit(1)

    dir_, matcher, replacement = sys.argv[1], sys.argv[2], sys.argv[3]

    # Change current directory
    os.chdir(dir_)

    for root, dirs, files in os.walk('.'):
        for file in files:
            filepath = os.path.join(root, file)
            if hidden(filepath):
                continue

            try:
                result = subprocess.run(
                    ['grep', '-qE', matcher, filepath],
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL
                )
            except Exception:
                continue

            if result.returncode == 0:
                print(filepath)
                with open(filepath, 'r', encoding='utf-8') as f:
                    content = f.read()
                new_content = re.sub(matcher, replacement, content)
                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(new_content)

if __name__ == "__main__":
    main()
